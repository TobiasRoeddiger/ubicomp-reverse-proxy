<html>
<header>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        .active {
            color: rgb(6, 214, 160);
            font-weight: bold;
        }

        .timeUpdate {
            cursor: pointer;
        }

        .lds-ring {
            display: inline-block;
            position: relative;
            width: 60px;
            height: 60px;
        }

        .lds-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 50px;
            height: 50px;
            margin: 6px;
            border: 6px solid rgb(169, 177, 221);
            border-radius: 50%;
            animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: rgb(169, 177, 221) transparent transparent transparent;
        }

        .lds-ring div:nth-child(1) {
            animation-delay: -0.45s;
        }

        .lds-ring div:nth-child(2) {
            animation-delay: -0.3s;
        }

        .lds-ring div:nth-child(3) {
            animation-delay: -0.15s;
        }

        @keyframes lds-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .live {
            height: 8px;
            width: 8px;
            background-color: red;
            border-radius: 50%;
            display: inline-block;
            animation:live 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        @keyframes live {
            0% {
                background-color: rgb(255, 162, 162);
            }

            50% {
                background-color: red;
            }

            100% {
                background-color: rgb(255, 162, 162);
            }
        }
    </style>
</header>

<body class="" style="margin: 0px;">
    <div style="display: flex; flex-flow: column; height: 100%">
        <div class="d-flex flex-row"
            style="width: 100%; background: rgb(29, 32, 51); font-family: 'DM Sans', sans-serif;padding: 10px;">
            <div class="d-flex flex-column justify-space-between flex: 0 1 auto">
                <div style="color: white; font-size: small; font-weight: bold;">Live Schedule</div>
                <div class="d-flex flex-row text-white mt-1 text-monospace" style="font-size: small;">
                    <div class="timeUpdate active" id="automatic" onclick="setAutomatic()">Automatic</div>
                    <div class="timeUpdate ml-2" onclick="setManual()" id="manual">Manual</div>
                </div>
                <input disabled style="font-size: small;" class="mt-1" id="datetime" type="datetime-local"
                    step="1"></input>
                <div class="mt-1" style="font-size: x-small; color: white;">All times shown in your local timezone.
                </div>
                <script>
                    var autoUpdates = true;

                    function setAutomatic() {
                        $('#manual').removeClass("active");
                        $('#automatic').addClass("active");
                        autoUpdates = true;
                        $('#datetime').attr("disabled", "")
                    }

                    function setManual() {
                        $('#automatic').removeClass("active");
                        $('#manual').addClass("active");
                        autoUpdates = false;
                        $('#datetime').removeAttr("disabled")
                    }
                </script>
            </div>
            <div class="text-monospace justify-content-center"
                style="font-size: small; margin-left: 20px; display: flex; flex-flow: row; flex: 1; overflow-x: auto;"
                id="text">
                <div class="lds-ring align-self-center"><div></div><div></div><div></div><div></div></div>
            </div>
        </div>

        <style>
            .scrollingTitle span {
                position: absolute;
                white-space: nowrap;
                transform: translateX(0);
                transition: 1s;
            }
        </style>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>

        <iframe id="gatherSpace" style="border: 0px; width: 100%; flex: 1 1 auto" allow="microphone;camera;midi;encrypted-media;clipboard-read;clipboard-write"
            src="https://gather.town/app/uBEfiDuhTpOg53yY/UbiComp2021"></iframe>
        <script>
            $(document).ready(() => {
                navigator.mediaDevices.getUserMedia({ audio: true, video: true });

                var now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('datetime').value = now.toISOString().slice(0, 19);
            });

            setInterval(() => {
                if (!autoUpdates) {
                    return;
                }

                var now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                if (document.getElementById('datetime').value !== now.toISOString().slice(0, 19)) {
                    document.getElementById('datetime').value = now.toISOString().slice(0, 19);
                }
            }, 1000)

            function toUTCDate(wString) {
                var years = parseInt(wString.substring(0, 4));
                var months = parseInt(wString.substring(5, 7));
                var days = parseInt(wString.substring(8, 10));
                var hours = parseInt(wString.substring(11, 13));
                var minutes = parseInt(wString.substring(14, 16));
                var seconds = parseInt(wString.substring(17, 19));

                var conferenceTimezoneOffset = 11;


                var date = new Date(Date.UTC(years, months - 1, days, hours + conferenceTimezoneOffset, minutes, seconds)); // js months is zero-based lol :(
                return date;
            }

            function cleanSessionName(name) {
                return name.replace("Track1", "").replace("Track2", "").replace("Track3", "").replace("Track4", "").replace(" Session1: ", "").replace(" Session2: ", "")
            }

            var data = {};
            var xmlHttp = new XMLHttpRequest();
            var presentations = [];
            var sessions = [];
            var sessionsLoaded = false;
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    data = JSON.parse(xmlHttp.responseText);
                    data.data.agenda.forEach(agenda => {
                        agenda.time_ranges.forEach(time_range => {
                            time_range[1].forEach(range => {
                                range.forEach(subrange => {
                                    subrange.sessions.forEach(session => {
                                        sessions.push({
                                            name: cleanSessionName(session.name),
                                            start: toUTCDate(session.calendar_stime),
                                            end: toUTCDate(session.calendar_etime),
                                            presentations: [],
                                            tracks: session.tracks
                                        })

                                        session.programs.forEach(presentationSet => {
                                            if (presentationSet !== undefined && presentationSet.length !== 0) {
                                                presentationSet.forEach(presentation => {
                                                    var processedPresentation = {
                                                        name: presentation.name,
                                                        start: toUTCDate(presentation.calendar_stime),
                                                        end: toUTCDate(presentation.calendar_etime),
                                                        tracks: presentation.tracks,
                                                        session_id: presentation.session_id,
                                                        session_order: presentation.session_order
                                                    }
                                                    sessions[sessions.length - 1].presentations.push(processedPresentation);
                                                });
                                            }
                                        });
                                    })
                                });
                            });
                        });
                    });
                    $('.lds-ring').remove();
                    sessionsLoaded = true;
                }
            }
            xmlHttp.open("GET", "/whova", true); // true for asynchronous 
            xmlHttp.send(null);

            function teleportToUrl(url) {
                $('#gatherSpace').attr('src', url)
            }


            function teleport(location) {
                location = location.toLowerCase().replace(/\s/g, "");
                switch (location) {
                    case "track1":
                        teleportToUrl("https://gather.town/app/uBEfiDuhTpOg53yY/UbiComp2021?spawnToken=NgBK2L5rRi0HqpFH")
                        break;
                    case "track2":
                        teleportToUrl("https://gather.town/app/uBEfiDuhTpOg53yY/UbiComp2021?spawnToken=KEGa0TOPHb63w3Fa")
                        break;
                    case "track3":
                        teleportToUrl("https://gather.town/app/uBEfiDuhTpOg53yY/UbiComp2021?spawnToken=uzo9ndIpelYyqf1B")
                        break;
                    case "track4":
                        teleportToUrl("https://gather.town/app/uBEfiDuhTpOg53yY/UbiComp2021?spawnToken=ikhhH9hUfx2x4CqZ")
                        break;
                    case "keynote":
                        alert("Sorry :( The spawn tile of this session was not specified.")
                        break;
                    case "opening":
                    alert("Sorry :( The spawn tile of this session was not specified.")
                        break;
                    default:
                        alert("Sorry :( The spawn tile of this session was not specified.")
                        break;
                }
            }


            setInterval(() => {
                var datetimeval = $("#datetime").val();
                if (!sessionsLoaded) {
                    return;
                }

                var currentTime = new Date(datetimeval);

                $('#text').empty();
                
                var validSessionCounter = 0;
                sessions.forEach(session => {
                    if (session.start < currentTime && session.end > currentTime) {
                        validSessionCounter++;
                        var presentations = "<div class='w-100 d-flex flex-column'>";
                        
                        var presentationsCounter = 0;
                        session.presentations.filter(x => x.end > currentTime).forEach((presentation, index) => {
                            presentationsCounter++;
                            if (index === 0) {
                                presentations += `<div style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;"><div class="mr-1 live"></div>${presentation.name}</div>`
                            } else if (index < 3) {
                                presentations += `<div style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${presentation.start.toLocaleTimeString().replace(":00", "")} ${presentation.name}</div>`
                            }
                        });
                        presentations += "</div>"

                        if (presentationsCounter === 0 && session.tracks[0].name.includes("Track")) presentations = "<div style='color: gray'><i>All presentations of this session are finished.</i></div>"

                        var tracks = `<div class="d-flex flex-row">`;
                        session.tracks.forEach(track => {
                            tracks += `<div class="badge" style="background-color: ${track.color}; color: white">${track.name}</div>`
                        })
                        tracks += "</div>"

                        $('#text').append(`<div class="card ml-2 mb-1 p-1 justify-content-between" style="color: black; border-color: transparent; font-size: x-small; flex-grow: 1; flex-basis: 0; min-width: 190px; max-width: 400px;">
                            <div class="d-flex flex-row justify-content-between align-items-center mb-1">
                                <div style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-weight: bold;">
                                    ${session.name}
                                </div>`
                                + tracks +
                            `</div>`
                            + presentations
                            + `<div>
                                <div class="badge align-self-end mt-1" style="background: black; cursor: pointer; color: white; font-size: 1em" onclick="teleport('${session.tracks[0].name}')">Teleport Now</div>    
                            </div>`
                            + `</div>`)
                    }
                });

                if (validSessionCounter === 0) {

                    $('#text').append("<div style='align-self: center;'><i style='color: #aaaaaa'>Currently no sessions are running.</i></div>")
                }
            }, 1000);
        </script>
    </div>
</body>

</html>